<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no, width=device-width" />
	<!-- change title to match the h1 heading -->
	<title>Batch update Using CMS API</title>
	<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css" />
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/normalize.css" />
	<script src="//use.edgefonts.net/source-code-pro.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/font-hack/2.015/css/hack-extended.min.css">

	<link rel="stylesheet" type="text/css" href="//docs.brightcove.com/en/styles/bcls-doc-site.css">
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/atelier-forest.light.min.css">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/font-hack/2.015/css/hack-extended.min.css">

	<style>
	input, select {
		max-width: 60%;
		font-size: .8rem;
	}
	fieldset {
		border: 1px #366 solid;
		border-radius: 5px;
	}
	textarea {
		width: 90%;
		height: 4rem;
		font-size: .8rem;
	}
	textarea#videoData {
		width: 90%;
		background-color: #f5f5f5;
		height: 24rem;
		font-size: .8rem;
	}
	</style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/js/vendor/modernizr.js"></script>
</head>

<body>
	<!-- header navbar -->
	<div id="navWrapper" class="fixed"></div>
	<!-- breadcrumbs -->
	<nav id="breadCrumbWrapper" class="breadcrumbs show-for-medium-up"></nav>
	<!-- search -->
	<div id="searchModal" class="reveal-modal" data-reveal></div>
	<!-- content -->
	<div class="row">
		<div class="sidebar large-2 columns show-for-large-up">
			<div id="sidenav" class="side-nav"></div>
		</div>
		<div id="main" class="large-10 small-12 columns">
			<header id="bcls_header" class="bcls-header">
            	<h1>Update Geo Properties Using the CMS API</h1>
                <p>This is a sample that updates the geo-filtering properties for all videos in an account. The app will only run on one of our sample accounts, but if you want to recreate it, all the code is in the <a href="#codepen">CodePen</a> except for the proxy that is used to get access tokens and make the API requests - the code for the proxy is shown <a href="#proxy">further down the page</a>.
                <h3>Limitations of this app</h3>
                <ul>
                	<li>The app updates all videos in the account with the same geo settings - it would be fairly simple to add options to select only a portion of the videos by requesting them by folder or some search criteria.</li>
                	<li>There is no exception-handling - for a small account like the one used here, it doesn't matter much - if an API request times out, the app will fail at that point, and you can simply rerun it; for a large account, you would want to add some exception handling - at least keep track of <code>offset</code> variable, which keeps track of how many videos have been processed, so that you could restart the app at that point.</li>
                	<li>For a large account, this would take some time to complete processing; any videos added after the app begins processing will be missed. The app tells you how many videos it processed, however, so you could get another count of videos afterwards to see if any were missed. The result are sorted by creation date ascending, so the missed videos will be the last ones added to account.</li>
                </ul>
			    </div>
                <div class="section" id="getCredentials">
                    <h2>Get credentials</h2>
                    <p>To use the CMS API you will need proper credentials. Later in this quick start, you will use the credentials in a form when submitting requests to the API.</p>
				<ol>
					<li>To obtain proper credentials use your choice of the <strong>Get Client Credentials</strong> documents listed below. Whichever option you choose, you will need to ask for the correct operation permissions. In this quick start you will need <strong>video</strong> operations. The following can be used with curl or Postman to get the proper permissions:</li>
				</ol>
				<p><code data-gist-id="7661acb7095f0c8b0e34" data-gist-hide-footer="true" data-gist-line="1-3"></code></p>
		        <ul>
		            <li><a href="http://docs.brightcove.com/en/video-cloud/oauth-api/guides/get-client-credentials.html">OAuth: Get Client Credentials Using CURL</a></li>
		            <li><a href="http://docs.brightcove.com/en/video-cloud/oauth-api/guides/get-client-credentials-postman.html">OAuth: Get Client Credentials Using Postman</a></li>
		        </ul>
                </div>
				<div class="section" id="codepen">
				    <h2>CodePen</h2>
				    <p data-height="800" data-theme-id="14832" data-slug-hash="NGMXeZ" data-default-tab="result" data-user="bcls" class='codepen'>See the Pen <a href='http://codepen.io/team/bcls/pen/NGMXeZ/'>Update Geo Properties via CMS API</a> by Brightcove Learning Services (<a href='http://codepen.io/bcls'>@bcls</a>) on <a href='http://codepen.io'>CodePen</a>.</p>
<script async src="//assets.codepen.io/assets/embed/ei.js"></script>
				</div>
				<div class="section" id="proxy">
				    <h2>Proxy code</h2>
				    <p>Below is the code for the proxy used with this sample. You can use it as is if you insert your <code>client_id</code> and <code>client_secret</code> values on lines 22-23, and deploy the file to a server where PHP is running. Or you can use this as a model for building a proxy in whatever language you like. If you are creating a server-side app, you can simply build the logic to get <a href="../../oauth-api/guides/get-token.html">access tokens</a> into your app.</p>
				    <p><script src="https://gist.github.com/8b18129a418cf0a080c0.js"></script></p>
				</div>
		</div>
	</div>
	<!-- bcl scripts -->
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/gist-embed/2.2/gist-embed.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/js/foundation.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.3/handlebars.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
	<script src="//docs.brightcove.com/en/scripts/docs-nav-data.min.js"></script>
	<script src="//docs.brightcove.com/en/scripts/bcls-doc-site-v1.js"></script>

	<script>
		$(document).foundation();
	</script>
	<script id="pageScript">
	var BCLS = ( function (window, document) {
		var account_id_field = document.getElementById("account_id"),
			account_id,
			client_id_field = document.getElementById("client_id"),
			client_id = null,
			client_secret_field = document.getElementById("client_secret"),
			client_secret = null,
			setRequest_btn = document.getElementById("setRequest"),
			apiRequest = null,
            apiRequest_field = document.getElementById("apiRequest"),
			submit_button = document.getElementById("submit"),
			response = document.getElementById("response"),
			totalVideos = 0,
			offset = 0,
			callNumber = 0,
			requestBody,
			videoData,
			t1,
			offset = 0,
			currentVideo,
			// functions
			isDefined,
			cleanString,
			cleanUpData,
			submitRequest,
			setRequest,
			logResponse,
			init;
		// is defined
		isDefined = function(x){
			if(x !== "" && x !== null && x !== undefined){
				return true;
			} else{
				return false;
			}
		};
		// function to remove spaces from string
		cleanString = function (str) {
			// remove spaces
			str = str.replace(/\s/g, "");
			return str;
		};
		// clean up data before submitting
		cleanUpData = function () {
			var i, iMax, item;
			iMax = videoData.length;
			for (i = 0; i < iMax; i++) {
				item = videoData[i];
				// truncate over-long descriptions
				if (item.description.length > 120) {
					item.description = item.description.substr(0, 250) + "...";
				}
				// use name for missing descriptions
				if (item.description === "") {
					item.description = item.name;
				}
			}
			// console.log("videoData Cleaned", videoData);
		}
		// function to set up request
		setRequest = function () {

			currentVideo = videoData[callNumber];
			if (isDefined(currentVideo)) {
				apiRequest = "https://cms.api.brightcove.com/v1/accounts/" + account_id + "/videos/" + currentVideo.id;
				requestBody = '{"description":"' + currentVideo.description + '"}';
				// display the request URL
				apiRequest_field.textContent = apiRequest;
				submitRequest();
			}

		}
		// function to set the request
		logResponse = function (data) {
			response.innerHTML += data + ",<br />"
		}
		// function to make API request
		submitRequest = function () {
		    var httpRequest = new XMLHttpRequest(),
				proxyURL = "https://solutions.brightcove.com/bcls/bcls-proxy/bcls-proxy.php",
				requestData,
				getResponse = function () {
					try {
					    if (httpRequest.readyState === 4) {
					      if (httpRequest.status === 200) {
					        logResponse(httpRequest.responseText);
					        if (callNumber < totalVideos) {
					        	callNumber++;
					        	setRequest();
					        }
					      } else {
					        alert("There was a problem with the request. Request returned " + httpRequest.status);
					      }
					    }
					  }
					  catch(e) {
					    alert('Caught Exception: ' + e);
					  }
				};
			if (account_id === null || client_id === null || client_secret === null) {
				alert("You must provide an account id, client id, and client secret");
				return false;
			}
			// get latest request URL in case use edited it
			apiRequest = cleanString(apiRequest_field.value);
			// set up request data
			requestData = "url=" + encodeURIComponent(apiRequest) + "&requestBody=" + encodeURIComponent(requestBody) + "&requestType=PATCH";
			// set response handler
			httpRequest.onreadystatechange = getResponse;
			// open the request
			httpRequest.open("POST", proxyURL);
			// set headers
			httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			// open and send request
			httpRequest.send(requestData);
		};
		// init function to set up event listeners
		init = function () {
			// event listeners
			setRequest_btn.addEventListener("click", function () {
				// trim any leading/trailing spaces from the input strings
				account_id = cleanString(account_id_field.value);
				client_id = cleanString(client_id_field.value);
				client_secret = cleanString(client_secret_field.value);
				// get and clean up video data
				videoData = JSON.parse(videoData_display.value);
				totalVideos = videoData.length;
				cleanUpData();
				// set up the request
				setRequest();
			});
		}
		// initialize - set up data
		init();

	})(window, document);
	</script>
<iframe id="CSAT" src="//learning-services-media.brightcove.com/doc-assets/general/surveylink.html" style="margin-left:40%; padding-bottom:20px;width:300px;border:none"></iframe>

<br><br>
<div class="bcls-footer"><a id="feedbackMail" href="mailto:docs@brightcove.com">Questions or comments?</a></div>
<script>
var feedbackMail = document.getElementById("feedbackMail");
feedbackMail.setAttribute("href", "mailto:docs@brightcove.com?subject=question regarding " + encodeURI(document.location.href));
</script>
</body>

</html>
